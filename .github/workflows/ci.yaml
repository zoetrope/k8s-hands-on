name: CI
on:
  pull_request:
  push:
    branches:
      - 'main'
env:
  go-version: 1.17
jobs:
  sync:
    name: Sync all applications
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version: ${{ env.go-version }}
      - run: go install github.com/yusukebe/t/cmd/t@latest
      - uses: aquaproj/aqua-installer@v1.1.2
        with:
          aqua_version: v1.17.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: make launch-k8s
      - run: make deploy-application
      - name: wait for sync
        run: |
          make port-forward-argocd
          make login-argocd
          retry sh -c 'kubectl get app -n argocd -o json | jq ".items | length" | t 10'
          IFS=$'\n'; for item in $(kubectl get app -n argocd -o json | jq -r '.items[].metadata.name'); do
            retry -max-time 15m argocd app wait $item --timeout 300
          done
      - name: check status
        run: |
          IFS=$'\n'; for item in $(kubectl get app -n argocd -o json | jq -c '.items[]'); do
            echo $item | jq -r .metadata.name
            echo $item | jq -r .status.health.status | t Healthy
            echo $item | jq -r .status.sync.status | t Synced
          done

name: CI
on:
  pull_request:
  push:
    branches:
      - 'main'
env:
  go-version: 1.17
jobs:
  sync:
    name: Sync all applications
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: ${{ env.go-version }}
      - run: go install github.com/yusukebe/t/cmd/t@latest
      - uses: aquaproj/aqua-installer@v0.7.0
        with:
          aqua_version: v0.10.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: make launch-k8s
      - run: make deploy-application
      - run: |
          make port-forward-argocd
          make login-argocd
          argocd app wait monitoring --timeout 300
      - run: |
          IFS=$'\n'; for item in $(kubectl get app -A -o json | jq -c '.items[]'); do
            echo $item | jq -r .metadata.name
            echo $item | jq -r .status.health.status | t Healthy
            echo $item | jq -r .status.sync.status | t Synced
          done
